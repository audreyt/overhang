<html>
<head>
<title>Cyclic Sankeys</title>
<style type="text/css">
#chart {
  height: 500px;
}

.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}

.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}

.linkish {
  fill: #111;
  stroke: #000;
  opacity: .3;
}

.link:hover {
  opacity: .5;
}

body {
  font-size: 12px;
}

</style>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="sankey.js"></script>
</head>

<body>

<div id="loop"></div> 
<script>

var _fillColors = d3.scale.category20();


function createSankey(container, data) {
  var nodes = data.nodes;
  var links = data.links;

  var width = 1200;
  var height = 600;

  var sankey = d3.sankey()
    .size([width - 200, height - 200])
    .nodeWidth(15)
    .nodePadding(10)
    .nodes(nodes)
    .links(links)
    .layout(32);  

  var svg = d3.select(container).append("svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr('transform',  'translate(' + 50 + ',' + 100 + ')');

  var path = sankey.reversibleLink();

  var linkEnter = svg.append("g").selectAll(".link")
      .data(links)
    .enter().append("g")
      .attr("class", "link")
      .attr("opacity", .2)
    .sort(function(a, b) { return b.dy - a.dy; });

  var path0 = linkEnter.append("path")
      .attr("class", "link0")
      .attr("fill", "none")
      .attr("d", path(0))
      .attr("class", "linkish");

  var path1 = linkEnter.append("path")
      .attr("class", "link1")
      .attr("fill", "none")
      .attr("d", path(1))
      .attr("class", "linkish");

  var path2 = linkEnter.append("path")
      .attr("class", "link2")
      .attr("fill", "none")
      .attr("d", path(2))
      .attr("class", "linkish");

  linkEnter.append("title")
    .text(function(d) { return d.source.name + " -> " + d.target.name; });

  var node = svg.append("g").selectAll(".node")
      .data(nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { this.parentNode.appendChild(this); })
      .on("drag", dragmove));

  node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) {
        return _fillColors(d.name);
      })
      .style("stroke", function(d) {
        return _fillColors(d.name);
      })
    .on("mouseover", function(d){
      svg.selectAll(".link")
          .filter(function(l){
            return l.source == d || l.target == d;
          })
        .transition()
          .style('opacity', .7);
    })
    .on("mouseout", function(d){
      svg.selectAll(".link")
          .filter(function(l){
            return l.source == d || l.target == d;
          })
        .transition()
          .style('opacity', .2);
    })
    .append("title")
      .text(function(d) { return d.name; });

  node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");

  function dragmove(d) {
    d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
    sankey.relayout();
    path1.attr('d', path(1));
    path0.attr('d', path(0));
    path2.attr('d', path(2));
  }

}

d3.json("ly-flow.json", function(data) {
  createSankey(document.getElementById('loop'), data);
});

</script>

</body>
</html>